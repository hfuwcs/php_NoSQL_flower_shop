# üìò GI·∫¢I TH√çCH CHI TI·∫æT: REDIS PREFIX TRONG LARAVEL

## üéØ PH·∫¶N 1: REDIS PREFIX L√Ä G√å?

### 1.1 ƒê·ªãnh nghƒ©a
Redis Prefix l√† m·ªôt chu·ªói k√Ω t·ª± ƒë∆∞·ª£c **t·ª± ƒë·ªông th√™m v√†o ƒë·∫ßu m·ªçi key** khi Laravel l∆∞u v√†o Redis.

### 1.2 T·∫°i sao c·∫ßn Prefix?
```
T∆∞·ªüng t∆∞·ª£ng b·∫°n c√≥ nhi·ªÅu ·ª©ng d·ª•ng Laravel d√πng chung 1 Redis server:
- App 1: Flower Shop  
- App 2: Book Store
- App 3: Music Store

N·∫øu KH√îNG c√≥ prefix:
‚ùå App 1 t·∫°o key: "user:1" 
‚ùå App 2 t·∫°o key: "user:1"  --> XUNG ƒê·ªòT!
‚ùå App 3 t·∫°o key: "user:1"  --> XUNG ƒê·ªòT!

N·∫øu C√ì prefix:
‚úÖ App 1 t·∫°o key: "flower-shop-database-user:1"
‚úÖ App 2 t·∫°o key: "book-store-database-user:1"
‚úÖ App 3 t·∫°o key: "music-store-database-user:1"  --> KH√îNG XUNG ƒê·ªòT!
```

---

## üîß PH·∫¶N 2: C·∫§U H√åNH PREFIX

### 2.1 File c·∫•u h√¨nh: `config/database.php`

```php
'redis' => [
    'options' => [
        'prefix' => env('REDIS_PREFIX', Str::slug((string) env('APP_NAME', 'laravel')).'-database-'),
    ],
]
```

**Gi·∫£i th√≠ch t·ª´ng b∆∞·ªõc:**

```php
// B∆∞·ªõc 1: L·∫•y APP_NAME t·ª´ file .env
env('APP_NAME', 'laravel')  
// K·∫øt qu·∫£: "Laravel"

// B∆∞·ªõc 2: Chuy·ªÉn th√†nh chu·ªói
(string) "Laravel"
// K·∫øt qu·∫£: "Laravel"

// B∆∞·ªõc 3: Slug h√≥a (chuy·ªÉn th√†nh ch·ªØ th∆∞·ªùng, thay space b·∫±ng -)
Str::slug("Laravel")
// K·∫øt qu·∫£: "laravel"

// B∆∞·ªõc 4: Th√™m '-database-' v√†o cu·ªëi
"laravel" . "-database-"
// K·∫øt qu·∫£: "laravel-database-"
```

### 2.2 Ki·ªÉm tra Prefix trong project

```bash
php artisan tinker
>>> config('database.redis.options.prefix')
=> "laravel-database-"
```

---

## üíæ PH·∫¶N 3: L∆ØU D·ªÆ LI·ªÜU V√ÄO REDIS

### 3.1 Code m·∫´u (trong Controller ho·∫∑c Command)

```php
use Illuminate\Support\Facades\Redis;

// B·∫°n vi·∫øt code:
Redis::hIncrBy('review:votes:69035212a150066473044174', 'upvotes', 1);
```

### 3.2 Qu√° tr√¨nh x·ª≠ l√Ω c·ªßa Laravel

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ B∆Ø·ªöC 1: Code c·ªßa b·∫°n                                        ‚îÇ
‚îÇ Redis::hIncrBy('review:votes:69035212a150066473044174', ...) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ B∆Ø·ªöC 2: Laravel Redis Facade nh·∫≠n l·ªánh                      ‚îÇ
‚îÇ - Key b·∫°n truy·ªÅn v√†o: "review:votes:69035212a150066473044174" ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ B∆Ø·ªöC 3: Laravel T·ª∞ ƒê·ªòNG TH√äM PREFIX                         ‚îÇ
‚îÇ $prefix = config('database.redis.options.prefix');         ‚îÇ
‚îÇ // $prefix = "laravel-database-"                            ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ $fullKey = $prefix . 'review:votes:69035212a150066473044174' ‚îÇ
‚îÇ // $fullKey = "laravel-database-review:votes:69035212..."   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ B∆Ø·ªöC 4: G·ª≠i l·ªánh xu·ªëng Redis Server                         ‚îÇ
‚îÇ HINCRBY "laravel-database-review:votes:69035212..." upvotes 1 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                          ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ B∆Ø·ªöC 5: L∆∞u v√†o Redis                                       ‚îÇ
‚îÇ Key th·ª±c t·∫ø trong Redis:                                    ‚îÇ
‚îÇ "laravel-database-review:votes:69035212a150066473044174"   ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ Value (Hash):                                               ‚îÇ
‚îÇ {                                                            ‚îÇ
‚îÇ   "upvotes": "1"                                            ‚îÇ
‚îÇ }                                                            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 3.3 Minh h·ªça b·∫±ng h√¨nh ·∫£nh

```
B·∫†N VI·∫æT CODE:          LARAVEL X·ª¨ L√ù:              REDIS L∆ØU:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇreview:votes: ‚îÇ  -->   ‚îÇlaravel-      ‚îÇ  -->   ‚îÇlaravel-database-    ‚îÇ
‚îÇ69035212a...  ‚îÇ  +     ‚îÇdatabase-     ‚îÇ  +     ‚îÇreview:votes:        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò        ‚îÇ69035212a150066473.. ‚îÇ
                                                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
     (1)                      (2)                        (3)
  Key ng·∫Øn              Th√™m prefix            Key ƒë·∫ßy ƒë·ªß trong Redis
```

---

## üîç PH·∫¶N 4: ƒê·ªåC D·ªÆ LI·ªÜU T·ª™ REDIS

### 4.1 C√≥ 2 C√ÅCH ƒê·ªåC kh√°c nhau - QUAN TR·ªåNG!

#### C√°ch 1: D√πng method th√¥ng th∆∞·ªùng (Laravel T·ª∞ ƒê·ªòNG x·ª≠ l√Ω prefix)

```php
// B·∫°n vi·∫øt:
$keys = Redis::keys('review:votes:*');

// Laravel x·ª≠ l√Ω:
// B∆∞·ªõc 1: Th√™m prefix v√†o pattern
$pattern = 'laravel-database-' . 'review:votes:*';
// $pattern = 'laravel-database-review:votes:*'

// B∆∞·ªõc 2: T√¨m keys
// K·∫øt qu·∫£: ["laravel-database-review:votes:69035212a150066473044174"]

// B∆∞·ªõc 3: T·ª∞ ƒê·ªòNG B·ªé PREFIX khi tr·∫£ v·ªÅ cho b·∫°n
// K·∫øt qu·∫£ b·∫°n nh·∫≠n: ["review:votes:69035212a150066473044174"]
```

**‚ö†Ô∏è NH∆ØNG trong th·ª±c t·∫ø, c√°ch n√†y KH√îNG ho·∫°t ƒë·ªông v·ªõi m·ªôt s·ªë method!**

#### C√°ch 2: D√πng command() ho·∫∑c keys() - Laravel KH√îNG t·ª± ƒë·ªông x·ª≠ l√Ω

```php
// B·∫°n vi·∫øt:
$keys = Redis::keys('*');

// Laravel G·ª¨I TR·ª∞C TI·∫æP xu·ªëng Redis, KH√îNG th√™m prefix
// K·∫øt qu·∫£: ["laravel-database-review:votes:69035212a150066473044174"]
// B·∫°n nh·∫≠n ƒë∆∞·ª£c key ƒê·∫¶Y ƒê·ª¶ PREFIX!
```

### 4.2 V·∫•n ƒë·ªÅ v·ªõi hGetAll()

```php
// ‚ùå SAI - S·∫Ω kh√¥ng l·∫•y ƒë∆∞·ª£c data
$votes = Redis::hGetAll('laravel-database-review:votes:69035212a150066473044174');
// K·∫øt qu·∫£: []  (r·ªóng)

// ‚úÖ ƒê√öNG - ƒê·ªÉ Laravel t·ª± th√™m prefix
$votes = Redis::hGetAll('review:votes:69035212a150066473044174');
// K·∫øt qu·∫£: ["upvotes" => "1", "downvotes" => "2"]
```

**T·∫°i sao?**

```
Khi b·∫°n truy·ªÅn: "laravel-database-review:votes:69035212..."
Laravel x·ª≠ l√Ω:  "laravel-database-" + "laravel-database-review:votes:69035212..."
K·∫øt qu·∫£ t√¨m:    "laravel-database-laravel-database-review:votes:69035212..."
                ^^^^^^^^^^^^^^^^ TH√äM 2 L·∫¶N PREFIX! --> KH√îNG T√åM TH·∫§Y!
```

---

## üîÑ PH·∫¶N 5: SYNC T·ª™ REDIS V√ÄO MONGODB

### 5.1 To√†n b·ªô Flow c·ªßa Command

```php
class SyncReviewVotesToDB extends Command
{
    public function handle()
    {
        // ============================================
        // B∆Ø·ªöC 1: L·∫§Y PREFIX T·ª™ CONFIG
        // ============================================
        $prefix = config('database.redis.options.prefix');
        // K·∫øt qu·∫£: "laravel-database-"
        
        Log::info("Using Redis prefix: '{$prefix}'");
        
        
        // ============================================
        // B∆Ø·ªöC 2: T√åM T·∫§T C·∫¢ KEYS TRONG REDIS
        // ============================================
        $allKeys = Redis::keys('*');
        // Redis::keys('*') KH√îNG t·ª± ƒë·ªông x·ª≠ l√Ω prefix
        // K·∫øt qu·∫£: 
        // [
        //   "laravel-database-review:votes:69035212a150066473044174",
        //   "laravel-database-laravel-cache-HacDIiCE...",
        //   ...
        // ]
        
        Log::info("All keys in Redis: " . json_encode($allKeys));
        
        
        // ============================================
        // B∆Ø·ªöC 3: L·ªåC CH·ªà L·∫§Y KEYS C·ª¶A VOTES
        // ============================================
        $pattern = $prefix . 'review:votes:';
        // $pattern = "laravel-database-review:votes:"
        
        $voteKeys = array_filter($allKeys, function($key) use ($prefix) {
            return str_starts_with($key, $prefix . 'review:votes:');
        });
        
        // K·∫øt qu·∫£: 
        // [
        //   "laravel-database-review:votes:69035212a150066473044174"
        // ]
        
        Log::info(count($voteKeys) . " vote key(s) found");
        
        
        // ============================================
        // B∆Ø·ªöC 4: X·ª¨ L√ù T·ª™NG KEY
        // ============================================
        foreach ($voteKeys as $redisKeyWithPrefix) {
            // $redisKeyWithPrefix = "laravel-database-review:votes:69035212..."
            
            Log::info("Processing: {$redisKeyWithPrefix}");
            
            
            // ----------------------------------------
            // B∆Ø·ªöC 4.1: B·ªé PREFIX RA
            // ----------------------------------------
            $keyWithoutPrefix = Str::after($redisKeyWithPrefix, $prefix);
            // Str::after("laravel-database-review:votes:69035...", "laravel-database-")
            // K·∫øt qu·∫£: "review:votes:69035212a150066473044174"
            
            
            // ----------------------------------------
            // B∆Ø·ªöC 4.2: L·∫§Y D·ªÆ LI·ªÜU T·ª™ REDIS
            // ----------------------------------------
            // ‚úÖ PH·∫¢I D√ôNG KEY KH√îNG C√ì PREFIX
            $votes = Redis::hGetAll($keyWithoutPrefix);
            // Laravel s·∫Ω T·ª∞ ƒê·ªòNG th√™m prefix:
            // "laravel-database-" + "review:votes:69035212..."
            // = "laravel-database-review:votes:69035212..."
            
            // K·∫øt qu·∫£:
            // [
            //   "upvotes" => "1",
            //   "downvotes" => "2"
            // ]
            
            Log::info("Votes data: " . json_encode($votes));
            
            
            // ----------------------------------------
            // B∆Ø·ªöC 4.3: EXTRACT REVIEW ID
            // ----------------------------------------
            $reviewId = str_replace('review:votes:', '', $keyWithoutPrefix);
            // str_replace('review:votes:', '', 'review:votes:69035212a150066473044174')
            // K·∫øt qu·∫£: "69035212a150066473044174"
            
            
            // ----------------------------------------
            // B∆Ø·ªöC 4.4: CHUY·ªÇN ƒê·ªîI D·ªÆ LI·ªÜU
            // ----------------------------------------
            $upvotes = (int) ($votes['upvotes'] ?? 0);
            $downvotes = (int) ($votes['downvotes'] ?? 0);
            // $upvotes = 1
            // $downvotes = 2
            
            Log::info("Review ID: {$reviewId}, Upvotes: {$upvotes}, Downvotes: {$downvotes}");
            
            
            // ----------------------------------------
            // B∆Ø·ªöC 4.5: T√åM REVIEW TRONG MONGODB
            // ----------------------------------------
            $review = Review::where('_id', $reviewId)->first();
            // T√¨m document trong collection 'reviews' c√≥ _id = "69035212a150066473044174"
            
            if ($review) {
                // Review t√¨m th·∫•y!
                Log::info("Found review in MongoDB. Current upvotes: {$review->upvotes}");
                
                
                // ----------------------------------------
                // B∆Ø·ªöC 4.6: C·∫¨P NH·∫¨T VOTES TRONG MONGODB
                // ----------------------------------------
                $review->increment('upvotes', $upvotes);
                // TƒÉng upvotes th√™m 1
                // Tr∆∞·ªõc: upvotes = 2
                // Sau:   upvotes = 3
                
                $review->increment('downvotes', $downvotes);
                // TƒÉng downvotes th√™m 2
                // Tr∆∞·ªõc: downvotes = 0
                // Sau:   downvotes = 2
                
                Log::info("Updated! New upvotes: {$review->upvotes}, New downvotes: {$review->downvotes}");
                
                
                // ----------------------------------------
                // B∆Ø·ªöC 4.7: X√ìA KEY TRONG REDIS
                // ----------------------------------------
                // ‚úÖ PH·∫¢I D√ôNG KEY KH√îNG C√ì PREFIX
                Redis::del($keyWithoutPrefix);
                // Laravel s·∫Ω T·ª∞ ƒê·ªòNG th√™m prefix:
                // "laravel-database-" + "review:votes:69035212..."
                // = "laravel-database-review:votes:69035212..."
                
                Log::info("Successfully deleted Redis key");
                
            } else {
                // Review KH√îNG t√¨m th·∫•y trong MongoDB
                Log::error("Review ID {$reviewId} not found in MongoDB!");
            }
        }
        
        
        // ============================================
        // B∆Ø·ªöC 5: HO√ÄN TH√ÄNH
        // ============================================
        $this->info("\nSync completed!");
        return 0;
    }
}
```

---

## üìä PH·∫¶N 6: SO S√ÅNH C√ÅC TR∆Ø·ªúNG H·ª¢P

### 6.1 B·∫£ng so s√°nh Key v·ªõi/kh√¥ng c√≥ Prefix

| T√¨nh hu·ªëng | Code b·∫°n vi·∫øt | Laravel x·ª≠ l√Ω | Key th·ª±c t·∫ø trong Redis |
|-----------|--------------|---------------|------------------------|
| **L∆∞u v√†o Redis** | `Redis::hSet('review:votes:123', ...)` | Th√™m prefix | `laravel-database-review:votes:123` |
| **ƒê·ªçc t·ª´ Redis (ƒë√∫ng)** | `Redis::hGetAll('review:votes:123')` | Th√™m prefix | T√¨m `laravel-database-review:votes:123` ‚úÖ |
| **ƒê·ªçc t·ª´ Redis (sai)** | `Redis::hGetAll('laravel-database-review:votes:123')` | Th√™m prefix | T√¨m `laravel-database-laravel-database-review:votes:123` ‚ùå |
| **T√¨m keys** | `Redis::keys('*')` | KH√îNG th√™m prefix | Tr·∫£ v·ªÅ `laravel-database-review:votes:123` (c√≥ prefix) |
| **X√≥a key (ƒë√∫ng)** | `Redis::del('review:votes:123')` | Th√™m prefix | X√≥a `laravel-database-review:votes:123` ‚úÖ |
| **X√≥a key (sai)** | `Redis::del('laravel-database-review:votes:123')` | Th√™m prefix | X√≥a `laravel-database-laravel-database-review:votes:123` ‚ùå |

### 6.2 Quy t·∫Øc v√†ng

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  QUY T·∫ÆC 1: KHI L∆ØU/ƒê·ªåC/X√ìA D·ªÆ LI·ªÜU                         ‚îÇ
‚îÇ  --> D√πng key KH√îNG c√≥ prefix                               ‚îÇ
‚îÇ  --> Laravel t·ª± ƒë·ªông th√™m prefix                            ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  ‚úÖ ƒê√∫ng:  Redis::hGetAll('review:votes:123')              ‚îÇ
‚îÇ  ‚ùå Sai:   Redis::hGetAll('laravel-database-review:votes:123') ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  QUY T·∫ÆC 2: KHI T√åM KEYS (Redis::keys)                      ‚îÇ
‚îÇ  --> K·∫øt qu·∫£ tr·∫£ v·ªÅ C√ì prefix                               ‚îÇ
‚îÇ  --> Ph·∫£i x·ª≠ l√Ω ƒë·ªÉ b·ªè prefix ra tr∆∞·ªõc khi d√πng             ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  $keys = Redis::keys('*');                                  ‚îÇ
‚îÇ  // ["laravel-database-review:votes:123"]  <-- C√ì PREFIX    ‚îÇ
‚îÇ                                                              ‚îÇ
‚îÇ  $keyWithoutPrefix = Str::after($key, $prefix);            ‚îÇ
‚îÇ  // "review:votes:123"  <-- B·ªé PREFIX                       ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üéì PH·∫¶N 7: V√ç D·ª§ TH·ª∞C T·∫æ HO√ÄN CH·ªàNH

### T√¨nh hu·ªëng: User vote cho m·ªôt review

```php
// ============================================
// 1. USER CLICK UPVOTE TR√äN WEBSITE
// ============================================
Route::post('/reviews/{id}/vote', function($id) {
    // Controller nh·∫≠n request
    $reviewId = $id; // "69035212a150066473044174"
    
    
    // ============================================
    // 2. L∆ØU V√ÄO REDIS (NHANH)
    // ============================================
    Redis::hIncrBy('review:votes:' . $reviewId, 'upvotes', 1);
    
    // Laravel x·ª≠ l√Ω:
    // - Key: "laravel-database-review:votes:69035212a150066473044174"
    // - Field: "upvotes"
    // - TƒÉng th√™m: 1
    
    // Trong Redis gi·ªù c√≥:
    // Key: "laravel-database-review:votes:69035212a150066473044174"
    // Value: {"upvotes": "1"}
    
    return response()->json(['success' => true]);
});


// ============================================
// 3. SCHEDULE CH·∫†Y SYNC (M·ªñI 5 PH√öT)
// ============================================
// File: app/Console/Kernel.php
protected function schedule(Schedule $schedule)
{
    $schedule->command('app:sync-review-votes-to-db')
             ->everyFiveMinutes();
}


// ============================================
// 4. COMMAND SYNC CH·∫†Y
// ============================================
// File: app/Console/Commands/SyncReviewVotesToDB.php

// B∆∞·ªõc 4.1: T√¨m t·∫•t c·∫£ keys
$allKeys = Redis::keys('*');
// ["laravel-database-review:votes:69035212a150066473044174", ...]

// B∆∞·ªõc 4.2: L·ªçc ch·ªâ l·∫•y vote keys
$prefix = "laravel-database-";
$voteKeys = array_filter($allKeys, function($key) use ($prefix) {
    return str_starts_with($key, $prefix . 'review:votes:');
});
// ["laravel-database-review:votes:69035212a150066473044174"]

// B∆∞·ªõc 4.3: X·ª≠ l√Ω t·ª´ng key
foreach ($voteKeys as $fullKey) {
    // $fullKey = "laravel-database-review:votes:69035212a150066473044174"
    
    // B·ªè prefix
    $key = Str::after($fullKey, $prefix);
    // $key = "review:votes:69035212a150066473044174"
    
    // L·∫•y d·ªØ li·ªáu (Laravel t·ª± th√™m prefix)
    $votes = Redis::hGetAll($key);
    // {"upvotes": "1"}
    
    // Extract review ID
    $reviewId = str_replace('review:votes:', '', $key);
    // "69035212a150066473044174"
    
    // C·∫≠p nh·∫≠t MongoDB
    $review = Review::find($reviewId);
    $review->increment('upvotes', (int) $votes['upvotes']);
    
    // X√≥a kh·ªèi Redis (Laravel t·ª± th√™m prefix)
    Redis::del($key);
}


// ============================================
// 5. K·∫æT QU·∫¢ CU·ªêI C√ôNG
// ============================================
MongoDB:
  reviews collection > document 69035212a150066473044174
    - upvotes: 3 (ƒë√£ tƒÉng t·ª´ 2 l√™n 3)
    - downvotes: 2

Redis:
  Key "laravel-database-review:votes:69035212a150066473044174" ƒë√£ b·ªã X√ìA
```

---

## ‚ö†Ô∏è PH·∫¶N 8: NH·ªÆNG L·ªñI TH∆Ø·ªúNG G·∫∂P

### L·ªói 1: D√πng key c√≥ prefix khi ƒë·ªçc/x√≥a

```php
// ‚ùå SAI
$key = "laravel-database-review:votes:123";
$data = Redis::hGetAll($key);  // Tr·∫£ v·ªÅ [] (r·ªóng)

// ‚úÖ ƒê√öNG
$key = "review:votes:123";
$data = Redis::hGetAll($key);  // Tr·∫£ v·ªÅ data
```

### L·ªói 2: Qu√™n filter keys khi d√πng Redis::keys('*')

```php
// ‚ùå SAI - L·∫•y t·∫•t c·∫£ keys k·ªÉ c·∫£ cache, session
$keys = Redis::keys('*');
foreach ($keys as $key) {
    // X·ª≠ l√Ω c·∫£ cache keys, session keys --> L·ªñI!
}

// ‚úÖ ƒê√öNG - Filter ch·ªâ l·∫•y vote keys
$keys = Redis::keys('*');
$voteKeys = array_filter($keys, function($key) {
    return str_starts_with($key, 'laravel-database-review:votes:');
});
foreach ($voteKeys as $key) {
    // Ch·ªâ x·ª≠ l√Ω vote keys
}
```

### L·ªói 3: D√πng scan() kh√¥ng ƒë√∫ng c√°ch

```php
// ‚ùå SAI - scan() kh√¥ng ho·∫°t ƒë·ªông t·ªët v·ªõi prefix
$cursor = 0;
do {
    [$cursor, $keys] = Redis::scan($cursor, 'match', 'laravel-database-review:votes:*');
} while ($cursor != 0);
// C√≥ th·ªÉ b·ªè s√≥t keys!

// ‚úÖ ƒê√öNG - D√πng keys() v√† filter
$allKeys = Redis::keys('*');
$voteKeys = array_filter($allKeys, function($key) {
    return str_starts_with($key, 'laravel-database-review:votes:');
});
```

---

## üéØ PH·∫¶N 9: T√ìM T·∫ÆT QUAN TR·ªåNG

### ƒêi·ªÅu c·∫ßn nh·ªõ:

1. **Prefix t·ª± ƒë·ªông**: Laravel T·ª∞ ƒê·ªòNG th√™m prefix khi b·∫°n l∆∞u/ƒë·ªçc/x√≥a
2. **Redis::keys('*')**: Tr·∫£ v·ªÅ keys ƒê·∫¶Y ƒê·ª¶ prefix, c·∫ßn x·ª≠ l√Ω tr∆∞·ªõc khi d√πng
3. **B·ªè prefix**: D√πng `Str::after($fullKey, $prefix)` ƒë·ªÉ l·∫•y key ng·∫Øn
4. **D√πng key ng·∫Øn**: Khi g·ªçi `hGetAll()`, `del()`, d√πng key KH√îNG c√≥ prefix

### Flow ƒë√∫ng:

```
1. Redis::keys('*')  
   --> Nh·∫≠n: "laravel-database-review:votes:123"

2. Str::after($key, 'laravel-database-')  
   --> Nh·∫≠n: "review:votes:123"

3. Redis::hGetAll('review:votes:123')  
   --> Laravel th√™m prefix: "laravel-database-review:votes:123"
   --> L·∫•y ƒë∆∞·ª£c data ‚úÖ

4. Redis::del('review:votes:123')  
   --> Laravel th√™m prefix: "laravel-database-review:votes:123"
   --> X√≥a th√†nh c√¥ng ‚úÖ
```

---

## üìù PH·∫¶N 10: CHECKLIST KHI DEBUG

Khi g·∫∑p l·ªói Redis, check c√°c ƒëi·ªÉm sau:

- [ ] Prefix c√≥ ƒë√∫ng kh√¥ng? (`config('database.redis.options.prefix')`)
- [ ] Key ƒëang d√πng c√≥ prefix ch∆∞a? (N·∫øu c√≥ --> SAI!)
- [ ] D√πng `Redis::keys('*')` ƒë·ªÉ xem t·∫•t c·∫£ keys trong Redis
- [ ] D√πng `Str::after()` ƒë·ªÉ b·ªè prefix
- [ ] Check log ƒë·ªÉ xem key th·ª±c t·∫ø Laravel g·ª≠i xu·ªëng Redis
- [ ] Test v·ªõi `Redis::hGetAll()` xem c√≥ l·∫•y ƒë∆∞·ª£c data kh√¥ng

---

**‚ú® Hy v·ªçng gi·∫£i th√≠ch n√†y gi√∫p b·∫°n hi·ªÉu r√µ h∆°n v·ªÅ Redis Prefix trong Laravel!**
